#!/usr/bin/env python3
# encoding: utf-8

import json
import requests
import xml.etree.ElementTree as etree
import os


def get_port(configpath='~/.config/syncthing/config.xml'):
    tree = etree.parse(os.path.expanduser(configpath))
    ip = tree.find('gui').find('address').text
    return ip.split(':')[-1]

def get_devices(port):
    config = requests.get("http://localhost:"+
                          port+"/rest/system/config").json()

    devs = {}
    for dev in config['devices']:
        devs[dev['deviceID']] = dev['name']

    return devs
        
def get_connections(port, devID=None):
    connections = requests.get("http://localhost:"+
                               port+"/rest/system/connections").json()
    conns = {}
    for dId, dConn in connections['connections'].items():

        if dConn['connected']:
            address = connections['connections'][dId]['address']
            ip, port = address.rsplit(':', maxsplit=1)
            ip = ip.strip('[]')
        else:
            ip = 'Not connected'
        conns[dId] = ip
    return conns


port = get_port()
devices = get_devices(port)
connections = get_connections(port)

status = requests.get("http://localhost:" + port+"/rest/system/status").json()
myId = status['myID']

for d_Id, d_name in devices.items():
    if d_Id in connections and d_Id != myId:
        print('{:12s}{}'.format(d_name, connections[d_Id]))
