#!/bin/bash



if [ $# -lt 1 ]; then
    echo "No destination defined. Usage: $0 destination" >&2
    exit 1
elif [ $# -gt 1 ]; then
    echo "Too many arguments. Usage: $0 destination" >&2
    exit 1
elif [ ! -d "$1" ]; then
   echo "Invalid path: $1" >&2
   exit 1
elif [ ! -w "$1" ]; then
   echo "Directory not writable: $1" >&2
   exit 1
fi

case "$1" in
  "/mnt") ;;
  "/mnt/"*) ;;
  "/media") ;;
  "/media/"*) ;;
  "/run/media") ;;
  "/run/media/"*) ;;
  *) echo "Destination not allowed." >&2
     exit 1
     ;;
esac

BUFOLD=$1
TIMESTAMP=`date +%Y%m%d-%H:%M`

borg create ${BUFOLD}::bu-${TIMESTAMP} /home /etc\
  --exclude-from /etc/borgmatic/excludes\
  --verbose --progress

borg prune --verbose --stats --list \
  --keep-hourly 3 \
  --keep-daily 7 \
  --keep-weekly 4 \
  --keep-monthly 6 \
  --keep-yearly 1 \
  ${BUFOLD}


#START=$(date +%s)
##rsync -aAXv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} /* "$1"
#sudo rsync -aAXv --delete --exclude={"mauro/musica/*","*/.cache/mozilla/*","*/.thumbnails/*","*/.cache/chromium/*","*/.local/share/Trash/*","mauro/video"} /home "$1"
#sudo rsync -aAXv --delete /etc "$1"
#FINISH=$(date +%s)
#echo "total time: $(( ($FINISH-$START) / 60 )) minutes, $((($FINISH-$START) % 60 )) seconds" | tee $1/"backup-from-$(date '+%Y-%m-%d-%T')"
